version: '3.8'

services:
  sophia-dashboard:
    build:
      context: ./sophia-dashboard-backend
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - GH_FINE_GRAINED_TOKEN=${GH_FINE_GRAINED_TOKEN}
      - MCP_BASE_URL=${MCP_BASE_URL:-http://localhost:8080}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - AIRBYTE_API_URL=${AIRBYTE_API_URL:-http://localhost:8000}
      - AIRBYTE_API_TOKEN=${AIRBYTE_API_TOKEN}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - NEON_DATABASE_URL=${NEON_DATABASE_URL}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-localhost:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-https://www.sophia-intel.ai}
    volumes:
      - ./sophia-dashboard-backend/var:/app/var
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - sophia-network

networks:
  sophia-network:
    external: true

